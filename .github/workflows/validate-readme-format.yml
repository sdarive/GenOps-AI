name: README Format Validation

on:
  pull_request:
    paths:
      - 'README.md'
  push:
    branches:
      - main
    paths:
      - 'README.md'

jobs:
  validate-readme:
    runs-on: ubuntu-latest
    name: Validate README Integration Format
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Validate README format
      id: validate
      run: |
        echo "Running README format validation..."
        python3 scripts/validate-readme-format.py README.md
        VALIDATION_EXIT_CODE=$?
        echo "validation_passed=$([[ $VALIDATION_EXIT_CODE == 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
        exit $VALIDATION_EXIT_CODE
        
    - name: Comment on PR with validation results
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const { execSync } = require('child_process');
          
          try {
            // Run validation again to get detailed output
            const output = execSync('python3 scripts/validate-readme-format.py README.md 2>&1', {
              encoding: 'utf8',
              maxBuffer: 1024 * 1024
            });
            
            const comment = `## ğŸš¨ README Format Validation Failed
            
The README integration list contains formatting violations that must be fixed before merging.

<details>
<summary>ğŸ“‹ Validation Results</summary>

\`\`\`
${output}
\`\`\`
</details>

### ğŸ”§ How to Fix

The most common issue is adding descriptive text to integration entries. Integration entries must follow these exact formats:

**âœ… Completed integrations:**
\`\`\`
- âœ… [Name](internal-link) (<a href="external-link" target="_blank">â†—</a>)
\`\`\`

**â˜ Planned integrations:**
\`\`\`
- â˜ Name (<a href="external-link" target="_blank">â†—</a>)
\`\`\`

**âŒ NEVER add descriptive text:**
\`\`\`
- âœ… [Name](link) (<a href="external" target="_blank">â†—</a>) - This descriptive text is FORBIDDEN
\`\`\`

### ğŸ“š References

- See \`CLAUDE.md\` for complete formatting guidelines
- Run \`python3 scripts/validate-readme-format.py\` locally to test fixes
- This validation prevents recurring formatting issues identified by the maintainers

This check is automatically enforced to maintain README consistency.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.error('Error running validation:', error);
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸš¨ README Format Validation Failed
              
There was an error validating the README format. Please run the validation script locally:

\`\`\`bash
python3 scripts/validate-readme-format.py README.md
\`\`\`

And fix any formatting violations before merging.`
            });
          }
          
    - name: Comment on successful validation
      if: success() && github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## âœ… README Format Validation Passed
            
All integration entries follow the correct format. Thank you for maintaining README consistency! ğŸ‰`
          });